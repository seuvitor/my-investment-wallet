!function(e){var t={};function n(o){if(t[o])return t[o].exports;var a=t[o]={i:o,l:!1,exports:{}};return e[o].call(a.exports,a,a.exports,n),a.l=!0,a.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)n.d(o,a,function(t){return e[t]}.bind(null,a));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t){const n=React.createElement,{HashRouter:o,NavLink:a,Route:l,Switch:r,useLocation:i,useParams:c,useHistory:s}=window.ReactRouterDOM,{AppBar:u,Box:d,Button:p,createMuiTheme:m,Chip:v,Dialog:g,DialogActions:f,DialogContent:h,DialogContentText:y,DialogTitle:b,Divider:C,Drawer:R,Icon:w,IconButton:x,Grid:k,ListItem:S,ListItemText:P,Menu:T,MenuItem:A,Paper:I,Snackbar:_,Table:B,TableBody:D,TableCell:E,TableContainer:O,TableHead:z,TableRow:L,TextField:M,ThemeProvider:N,Toolbar:F,Typography:j}=MaterialUI,V="https://carteira-investimentos.auth.us-east-1.amazoncognito.com/oauth2/token",W=({children:e})=>{const[t]=React.useState(m({palette:{primary:{main:"#556cd6"},secondary:{main:"#19857b"}}}));return n(N,{theme:t},e)},Q=React.createContext(),U=({children:e})=>{const[t,o]=React.useState(""),[a,l]=React.useState(!1),r=React.useCallback(e=>{o(e),l(!0)},[]),i=()=>{o(""),l(!1)};return n(Q.Provider,{value:{showMessage:r}},e,n(_,{anchorOrigin:{vertical:"bottom",horizontal:"left"},open:a,autoHideDuration:5e3,onClose:i,message:t,action:n(x,{color:"inherit",onClick:i},n(w,null,"close"))},null))},$=React.createContext(),G=({children:e})=>{const[t,o]=React.useState({id:void 0,name:void 0,email:void 0,groups:void 0,idToken:void 0,accessToken:void 0}),[a,l]=React.useState(void 0),[r,i]=React.useState(void 0),[c]=React.useState(15e5),[s,u]=React.useState(void 0),d=React.useCallback(()=>new Promise(e=>{o({id:void 0,name:void 0,email:void 0,groups:void 0,idToken:void 0,accessToken:void 0}),l(void 0),i(void 0),e()}),[]);React.useEffect(()=>{i(s?e=>e?(e.update({credentials:s}),e):new AWS.Config({region:"us-east-1",credentials:s}):void 0)},[s]);const p=React.useCallback((e,t)=>{const n=new AWS.CognitoIdentityCredentials({IdentityPoolId:"us-east-1:874c45d2-0eb6-4d04-92f0-b8769dcbcc54",...e&&{Logins:{"cognito-idp.us-east-1.amazonaws.com/us-east-1_SjfN8ExVX":e}}},{region:"us-east-1"});return new Promise((a,l)=>{n.clearCachedId(),n.getPromise().then(()=>{u(n),o(n=>{const o=e&&JSON.parse(atob(e.split(".")[1]));return n.id=o&&o.sub,n.name=o?o.name:"Usuário não logado",n.email=o&&o.email,n.groups=o&&o["cognito:groups"],n.idToken=e,n.accessToken=t,n}),a()}).catch(e=>{u(void 0),o({id:void 0,name:void 0,email:void 0,groups:void 0,idToken:void 0,accessToken:void 0}),console.warn("Could not validate credentials",e),l(e)})})},[]),m=React.useCallback(e=>new Promise((t,n)=>{e?fetch(V,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:"grant_type=refresh_token&client_id=7s3vb9runcfjvgetrvhdfd97at&refresh_token="+e}).then(e=>{e.json().then(e=>{p(e.id_token,e.access_token).then(()=>{t()}).catch(e=>{console.error("Could not login with refreshed tokens",e),n(e)})}).catch(e=>{console.error("Could not decode authentication response",e),n(e)})}).catch(e=>{console.error("Could not get refreshed tokens",e),n(e)}):(console.warn("No refreshToken available"),n(new Error("No refreshToken available")))}),[p]);((e,t)=>{const n=React.useRef(),o=React.useCallback(()=>{const e=n.current;e&&(n.current=void 0,clearInterval(e))},[n]);React.useEffect(()=>(n.current=setInterval(e,t),o),[e,t,o])})(React.useCallback(()=>{m(a).catch(e=>{console.error("Could not refresh tokens",e)})},[a,m]),c);const v=React.useCallback(()=>p(),[p]),g=React.useCallback(e=>new Promise((t,n)=>{fetch(V,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`grant_type=authorization_code&client_id=7s3vb9runcfjvgetrvhdfd97at&code=${e}&redirect_uri=https://seuvitor.github.io/my-investment-wallet/?auth-redirect`}).then(e=>{e.json().then(e=>{m(e.refresh_token).then(()=>{l(e.refresh_token),t()}).catch(e=>{console.error("Could not login with refreshed tokens",e),l(void 0),n(e)})}).catch(e=>{console.error("Could not decode authentication response",e),l(void 0),n(e)})}).catch(e=>{console.error("Could not get identification tokens with this authorization code",e),l(void 0),n(e)})}),[m]);return n($.Provider,{value:{user:t,awsConfig:r,awsCredentials:s,loginAnonymously:v,loginWithAuthorizationCode:g,logoff:d}},e)},q=React.createContext(),H=({children:e})=>{const{awsConfig:t,awsCredentials:o}=React.useContext($),[a,l]=React.useState();return React.useEffect(()=>{l(t?new AWS.DynamoDB.DocumentClient(t):void 0)},[t]),React.useEffect(()=>{o&&l(e=>(e&&e.service.config.update({credentials:o}),e))},[o]),n(q.Provider,{value:{documentDB:a}},e)},J=React.createContext(),K=({children:e})=>{const{user:{accessToken:t},awsConfig:o,awsCredentials:a}=React.useContext($),[l,r]=React.useState();React.useEffect(()=>{r(o?new AWS.Lambda(o):void 0)},[o]),React.useEffect(()=>{a&&r(e=>(e&&e.config.update({credentials:a}),e))},[a]);const i=React.useCallback((e,n)=>{const o={FunctionName:e,ClientContext:btoa(JSON.stringify({accessToken:t}))};return n&&(o.Payload=JSON.stringify(n)),new Promise((e,t)=>{l.invoke(o).promise().then(n=>{n.StatusCode&&200===n.StatusCode&&n.Payload||t(n);const o=JSON.parse(n.Payload);o&&o.statusCode&&200===o.statusCode||t(n),e(o.body)}).catch(e=>{t(e)})})},[l,t]);return n(J.Provider,{value:{invokeLambda:l&&i}},e)},X=({children:e})=>n(W,null,n(U,null,n(G,null,n(H,null,n(K,null,e))))),Y=()=>{const{showMessage:e}=React.useContext(Q),{user:{name:t},loginAnonymously:o}=React.useContext($),[a,l]=React.useState(!1),r=()=>l(!1);return t?null:n(React.Fragment,null,n(p,{color:"inherit",onClick:()=>l(!0)},"Login"),n(g,{open:a,onClose:r},n("form",{onSubmit:t=>{t.preventDefault(),o().then(()=>{e("Login succesful."),r()}).catch(t=>{e("Login failed."),console.error("Login failed.",t)})}},n(b,null,"Login"),n(h,null,n(y,null,"Login using AWS Incognito identity pool"),n(M,{name:"awsRegion",defaultValue:"us-east-1",label:"AWS Region",autoFocus:!0,variant:"filled",fullWidth:!0},null),n(M,{name:"awsIdentityPoolId",defaultValue:"us-east-1:874c45d2-0eb6-4d04-92f0-b8769dcbcc54",label:"AWS Identity Pool Id",variant:"filled",fullWidth:!0},null)),n(f,null,n(p,{onClick:r},"Cancel"),n(p,{type:"submit"},"Login")))))},Z=()=>{const{showMessage:e}=React.useContext(Q),{user:{name:t},logoff:o}=React.useContext($),[a,l]=React.useState(!1),r=React.useRef(null);return t?n(React.Fragment,null,n(x,{color:"inherit",ref:r,onClick:()=>{l(!0)}},n(w,null,"account_circle")),n(T,{open:a,onClose:()=>{l(!1)},anchorEl:r.current,anchorOrigin:{vertical:"top",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"right"}},n(A,{disabled:!0},t),n(C,null,null),n(A,{onClick:()=>{o().then(()=>{e("Logoff succesful")}).catch(()=>{e("Logoff failed")}),l(!1)}},"Logoff"))):null},ee=({setDrawerOpen:e,routes:t})=>{const o=i(),a=t.find(e=>e.path===o.pathname);return n(u,null,n(F,null,n(x,{edge:"start",color:"inherit",onClick:()=>e(!0)},n(w,null,"menu")),n(j,{style:{flexGrow:1}},a?a.label:""),n(Y,null,null),n(Z,null,null)))},te=({routes:e,drawerOpen:t,setDrawerOpen:o})=>{const{user:{groups:l}}=React.useContext($),r=()=>o(!1);return n(R,{open:t,onClose:r},n(F,{onClick:r,style:{padding:"inherit"}},n(S,{button:!0,style:{justifyContent:"flex-end",height:"100%"}},n(w,null,"chevron_left"))),n(C,null,null),e.filter(e=>!e.hideFromMenu).filter(e=>{return!(t=e.authorizedGroups)||!!l&&t.some(e=>l.includes(e));var t}).map(e=>n(S,{key:e.name+"-route-drawer-item",button:!0,component:a,activeClassName:"Mui-selected",to:e.path,onClick:r,...e.options},n(P,{primary:e.label},null))))},ne=()=>n("div",null,null),oe=()=>{const{showMessage:e}=React.useContext(Q),{loginWithAuthorizationCode:t}=React.useContext($),{authorization_code:o}=c(),a=s();return React.useEffect(()=>{t(o).then(()=>{e("Usuário logado com sucesso"),a.replace("/")}).catch(t=>{e("Não foi possível completar o login"),console.error("Não foi possível completar o login",t)})},[o,t,e,a]),n("div",null,null)},ae=(e,t,n=2)=>new Big(e).plus(t).toFixed(null===n?void 0:n),le=(e,t)=>new Big(e).minus(new Big(t)).toFixed(2),re=(e,t,n=2)=>new Big(e).times(new Big(t)).toFixed(null===n?void 0:n),ie=(e,t,n=Big.DP,o=Big.RM)=>new Big(e).div(new Big(t)).round(n,o).toFixed(n),ce=e=>e.map(e=>new Big(e)).reduce((e,t)=>e.plus(t),new Big(0)).toFixed(2),se=({setAvailableValue:e})=>{const[t,o]=React.useState(!0);return n("form",{onSubmit:t=>{t.preventDefault(),e(t.target.availableValue.value)}},n(k,{container:!0,alignItems:"center",spacing:2},n(k,{item:!0,xs:12},n(j,{variant:"body1"},"Informe o valor disponível para calcular a alocação proporcional")),n(k,{item:!0},n(M,{name:"availableValue",label:"Valor disponível",variant:"filled",onChange:e=>{try{Big(e.target.value),o(!0)}catch(e){o(!1)}},error:!t},null)),n(k,{item:!0},n(p,{type:"submit",variant:"contained",color:"primary",disabled:!t},"Calcular aportes"))))},ue=({defaultCurrency:e,otherCurrencies:t})=>{const{documentDB:n}=React.useContext(q),[o,a]=React.useState(void 0);React.useEffect(()=>{if(n){const o=t.map(t=>`${t}/${e}`);Promise.all(o.map(e=>(async(e,t)=>{const n={TableName:"price",Key:{timestamp:"now"},ProjectionExpression:"prices.#assetCode",ExpressionAttributeNames:{"#assetCode":t}},o=await e.get(n).promise();if(!o.Item||!o.Item.prices)throw new Error("Price data not found");return o.Item.prices[t]})(n,e))).then(e=>{const n=e.reduce((e,n,o)=>({...e,[t[o]]:n}),{});a(n)}).catch(e=>{a(void 0),console.error("Could not get currency exchange rates",e)})}else a(void 0)},[n,e,t]);const l=React.useCallback((t,n)=>n===e?t:re(t,o[n]),[o,e]),r=React.useCallback((t,n)=>n===e?t:re(t,ie("1",o[n])),[o,e]);return{toDefaultCurrency:o&&l,backToAssetCurrency:o&&r}},de=()=>{const{user:{id:e}}=React.useContext($),{documentDB:t}=React.useContext(q),[o,a]=React.useState(void 0),[l,r]=React.useState(void 0),[i,c]=React.useState(void 0),[s]=React.useState({defaultCurrency:"BRL",otherCurrencies:["USD"]}),{toDefaultCurrency:u,backToAssetCurrency:p}=ue(s);React.useEffect(()=>{t&&e?((e,t)=>{const n={TableName:"priced_position",Key:{user_id:t},AttributesToGet:["assets"]};return new Promise((t,o)=>{e.get(n).promise().then(e=>{t(e.Item&&e.Item.assets)}).catch(e=>{o(e)})})})(t,e).then(e=>{a({assets:e})}).catch(()=>{a(void 0)}):a(void 0)},[t,e]),React.useEffect(()=>{if(o&&o.assets&&o.assets.length&&l&&u&&p){const e=ce(o.assets.map(e=>u(e.value,e.currency))),t=ae(e,l),n=[...o.assets];n.forEach(e=>{var n,o;e.idealFutureValue=p((n=t,o=e.targetPercent,re(n,ie(o,100,Big.DP))),e.currency)}),n.forEach(e=>{var t,n;e.idealInvestment=(t="0.00",n=le(e.idealFutureValue,e.value),new Big(t).cmp(new Big(n))>=0?t:n)});const a=ce(n.map(e=>u(e.idealInvestment,e.currency)));n.forEach(e=>{e.proportionalizedIdealInvestment=p(((e,t,n,o=2)=>re(e,ie(t,n,Big.DP),o))(u(e.idealInvestment,e.currency),l,a),e.currency)}),n.forEach(e=>{e.investmentQuantity=re(e.minimum,ie(e.proportionalizedIdealInvestment,re(e.price,e.minimum,Big.DP),0,0),null)}),n.forEach(e=>{e.investment=re(e.investmentQuantity,e.price)});const r=ce(n.map(e=>u(e.investment,e.currency))),i=le(l,r);n.forEach(e=>{e.futureQuantity=ae(e.quantity,e.investmentQuantity,null)}),n.forEach(e=>{e.futureValue=re(e.futureQuantity,e.price)});const s=ce(n.map(e=>u(e.futureValue,e.currency)));n.forEach(e=>{e.futurePercent=re("100.00",ie(u(e.futureValue,e.currency),s),4)}),c({assets:n,totalInvestment:r,remainingAvailableValue:i})}else c(void 0)},[o,l,u,p]);const m=i&&i.assets||o&&o.assets;return n(React.Fragment,null,n(se,{setAvailableValue:r},null),n(C,{absolute:!1,style:{marginTop:"0.5em",marginBottom:"0.5em"}},null),m&&n(O,{component:d,style:{width:"fit-content"}},n(B,{style:{tableLayout:"auto",borderCollapse:"separate",borderSpacing:"10px"}},n(z,null,n(L,null,n(E,{style:{border:0}}),n(E,{style:{border:0}}),n(E,{align:"center",style:{border:0}},"Posição atual"),i&&n(E,{style:{border:0}}),i&&n(E,{align:"center",style:{border:0}},"Novo aporte"),i&&n(E,{style:{border:0}}),i&&n(E,{align:"center",style:{border:0}},"Posição futura"))),n(D,null,m.map(e=>n(L,{key:e.code},n(E,{style:{display:"contents"}},n(d,{component:I,p:2,style:{display:"table-cell",verticalAlign:"middle"}},n(k,{container:!0},n(k,{item:!0,xs:6},n(j,null,e.code)),n(k,{item:!0,xs:6,align:"right"},n(j,{variant:"caption",color:"textSecondary"},e.currency+" "),n(j,{display:"inline"},""+e.price)),n(k,{item:!0,xs:12},n(v,{size:"small",label:e.name}))))),n(E,{style:{display:"contents"}},n(d,{component:I,p:2,align:"center",style:{display:"table-cell",verticalAlign:"middle"}},n(j,{variant:"caption",color:"textSecondary"},"objetivo"),n(j,null,e.targetPercent+"%"))),n(E,{style:{display:"contents"}},n(d,{component:I,p:2,align:"center",style:{display:"table-cell",verticalAlign:"middle"}},n(j,{variant:"caption",display:"block"},e.quantity+" cotas"),n(j,{variant:"caption",color:"textSecondary"},e.currency+" "),n(j,{display:"inline"},""+e.value),n(j,{variant:"body2"},e.currentPercent+"%"))),i&&n(E,{padding:"none",align:"center",style:{border:0}},n(w,null,"chevron_right")),i&&n(E,{style:{display:"contents"}},n(d,{component:I,p:2,align:"center",elevation:"0"===e.investmentQuantity?1:6,style:{display:"table-cell",verticalAlign:"middle",..."0"!==e.investmentQuantity&&{backgroundColor:"lightblue"}}},n(j,{variant:"caption"},e.code),n(j,{style:{..."0"!==e.investmentQuantity&&{fontWeight:"bold"}}},e.investmentQuantity+" cotas"),n(j,{variant:"caption",color:"textSecondary"},e.currency+" "),n(j,{variant:"caption"},""+e.investment))),i&&n(E,{padding:"none",align:"center",style:{border:0}},n(w,null,"chevron_right")),i&&n(E,{style:{display:"contents"}},n(d,{component:I,p:2,align:"center",style:{display:"table-cell",verticalAlign:"middle"}},n(j,{variant:"caption",display:"block"},e.futureQuantity+" cotas"),n(j,{variant:"caption",color:"textSecondary"},e.currency+" "),n(j,{display:"inline"},""+e.futureValue),n(j,{variant:"body2"},e.futurePercent+"%"))))),n(L,null,n(E,{style:{border:0}}),n(E,{style:{border:0}}),n(E,{style:{border:0}}),i&&n(E,{style:{border:0}}),i&&n(E,{align:"center",padding:"none",style:{border:0}},n(d,{component:I,p:2,elevation:6,align:"center"},n(j,{variant:"caption",color:"textSecondary",display:"block"},"aporte efetivo"),n(j,{variant:"caption",color:"textSecondary"},s.defaultCurrency+" "),n(j,{display:"inline"},""+i.totalInvestment),n(C,{light:!0,variant:"fullWidth"},null),n(j,{variant:"caption",color:"textSecondary",display:"block"},"valor restante"),n(j,{variant:"caption",color:"textSecondary"},s.defaultCurrency+" "),n(j,{display:"inline"},""+i.remainingAvailableValue))),i&&n(E,{style:{border:0}}),i&&n(E,{style:{border:0}}))))))},pe=()=>{const{user:{id:e}}=React.useContext($),{documentDB:t}=React.useContext(q),[o,a]=React.useState([]);return React.useEffect(()=>{t&&e?((e,t)=>{const n={TableName:"target_allocation",Key:{user_id:t},AttributesToGet:["allocations"]};return new Promise((t,o)=>{e.get(n).promise().then(e=>{t(e.Item&&e.Item.allocations)}).catch(e=>{o(e)})})})(t,e).then(e=>{a(e)}).catch(()=>{a([])}):a([])},[t,e]),o.length>0&&n(O,{component:I,style:{width:"fit-content"}},n(B,{style:{tableLayout:"auto"}},n(z,null,n(L,null,n(E,null,"Categoria"),n(E,null,"Moeda"),n(E,null,"Objetivo"))),n(D,null,o.map(({category:e,currency:t,percent:o})=>n(L,{key:`${e}|${t}`},n(E,null,e),n(E,null,t),n(E,null,o+"%"))))))},me=(e,t,n)=>{t("update_asset_allocation",{user_id:n}).then(()=>{e("Portfólio atualizado com sucesso")}).catch(t=>{e("Não foi possível atualizar o portfólio"),console.error("Não foi possível atualizar o portfólio",t)})},ve=()=>{const{showMessage:e}=React.useContext(Q),{user:t}=React.useContext($),{invokeLambda:o}=React.useContext(J);return n("div",{},n(p,{variant:"contained",onClick:()=>{me(e,o,t.id)},disabled:!o},"Atualizar Portfólio"))},ge=()=>{const{showMessage:e}=React.useContext(Q),{user:t}=React.useContext($),{invokeLambda:o}=React.useContext(J),a=React.useRef(),l=n=>{const a=n.target.result;let l;try{l=a.split(/\r\n|\n/).slice(1).map(e=>[...e.matchAll(/"[^"]*"|[^,]+/g)]).reduce((e,t)=>{const[n,o]=t.map(e=>e[0]).map(e=>e.replace(/^"(.*)"$/,"$1")).map(e=>e.replace(",","."));return{...e,[n]:o}},{})}catch(t){e("Não foi possível carregar o arquivo"),console.error("Não foi possível carregar o arquivo",t)}l&&o("update_prices",{prices:l}).then(()=>{e("Preços atualizados com sucesso"),me(e,o,t.id)}).catch(t=>{e("Não foi possível atualizar os preços"),console.error("Não foi possível atualizar os preços",t)})};return n("form",{ref:a},n("input",{id:"contained-button-file",accept:".csv",type:"file",style:{display:"none"},onChange:e=>{const t=new FileReader;t.onload=l,t.onloadend=()=>a.current.reset(),t.readAsText(e.target.files[0])},disabled:!o},null),n("label",{htmlFor:"contained-button-file"},n(p,{disabled:!o,variant:"contained",color:"primary",component:"span"},"Upload Preços Atualizados")))};if("/my-investment-wallet/"===window.location.pathname){const e=new URLSearchParams(window.location.search);null!==e.get("auth-redirect")&&null!==e.get("code")&&window.history.replaceState({},"","/my-investment-wallet/#/authentication/"+e.get("code"))}ReactDOM.render(n(()=>{const[e,t]=React.useState(!1),a=[{name:"main",label:"Main",path:"/",search:"?login-page=:page&code=:code",component:ne,options:{exact:!0}},{name:"update-allocation",label:"Update Allocation",path:"/update-allocation",component:ve},{name:"upload-prices",label:"Upload Prices",path:"/upload-prices",authorizedGroups:["admin"],component:ge},{name:"suggestedAllocation",label:"Alocação Sugerida",path:"/suggested-allocation",component:de},{name:"target-allocation",label:"Macro-Alocação",path:"/target-allocation",component:pe},{name:"authentication",label:"Athentication",path:"/authentication/:authorization_code",hideFromMenu:!0,component:oe}];return n(X,null,n(o,null,n(ee,{setDrawerOpen:t,routes:a},null),n(te,{routes:a,drawerOpen:e,setDrawerOpen:t}),n(F,null,null),n(r,null,a.map(e=>n(l,{key:e.name+"-route",path:e.path,...e.options},n(e.component))))))},null,null),document.getElementById("app_container"))}]);